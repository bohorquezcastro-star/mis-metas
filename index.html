<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas, Calendario & Alertas Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .fc { color: white; background: rgba(0,0,0,0.2); border-radius: 1rem; padding: 10px; font-size: 0.85rem; }
        .fc-toolbar-title { font-size: 1rem !important; }
        .fc-button { background-color: #4f46e5 !important; border: none !important; padding: 4px 8px !important; font-size: 0.75rem !important; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="bg-[#05070a] min-h-screen text-white p-4 font-sans selection:bg-indigo-500">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="glass p-6 rounded-[2rem] shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4">
                    <button onclick="requestNotificationPermission()" id="notif-btn" class="text-indigo-400 hover:text-white transition-colors" title="Activar Notificaciones">
                        ðŸ””
                    </button>
                </div>
                <h1 id="greeting" class="text-2xl font-black mb-1">Â¡Hola! ðŸš€</h1>
                <p class="text-indigo-400 text-[10px] uppercase tracking-[0.2em] mb-6">Sistema de Alertas Activado</p>

                <div class="space-y-4">
                    <input type="text" id="goalInput" placeholder="Â¿QuÃ© quieres lograr?" class="w-full bg-white/5 border border-white/10 p-3 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none text-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="goalDate" class="bg-white/5 border border-white/10 p-3 rounded-2xl text-xs">
                        <input type="time" id="goalTime" class="bg-white/5 border border-white/10 p-3 rounded-2xl text-xs" title="Hora de la alerta">
                    </div>
                    <select id="goalPriority" class="w-full bg-slate-900 border border-white/10 p-3 rounded-2xl text-sm appearance-none">
                        <option value="low">Prioridad Baja</option>
                        <option value="medium">Prioridad Media</option>
                        <option value="high">Prioridad Alta</option>
                    </select>
                    <button onclick="addGoal()" class="w-full bg-indigo-600 hover:bg-indigo-500 py-4 rounded-2xl font-black transition-all shadow-xl shadow-indigo-600/20 uppercase text-xs tracking-widest">
                        Programar y Alertar
                    </button>
                </div>
            </div>

            <div class="glass p-6 rounded-[2.5rem] h-[350px] flex flex-col">
                <h2 class="text-xs font-bold mb-4 text-indigo-300 uppercase tracking-widest">Hoy</h2>
                <ul id="goalList" class="space-y-3 overflow-y-auto flex-1 custom-scrollbar pr-2 text-sm"></ul>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="glass p-6 rounded-[2.5rem] h-full">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <script>
        let goals = JSON.parse(localStorage.getItem('alert_goals_v2')) || [];
        let calendar;

        document.addEventListener('DOMContentLoaded', function() {
            const userName = localStorage.getItem('userName_v3') || 'Usuario';
            document.getElementById('greeting').innerText = `Â¡Hola, ${userName}! ðŸ‘‹`;
            document.getElementById('goalDate').valueAsDate = new Date();
            
            initCalendar();
            renderGoals();
            checkNotificationsLoop();
        });

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'dayGridMonth,listMonth' },
                events: getEvents(),
                eventClick: (info) => toggleGoal(info.event.id)
            });
            calendar.render();
        }

        function getEvents() {
            return goals.map((g, index) => ({
                id: index.toString(),
                title: g.text,
                start: g.date + (g.time ? 'T' + g.time : ''),
                color: g.completed ? '#10b981' : (g.priority === 'high' ? '#f43f5e' : '#6366f1')
            }));
        }

        // --- SISTEMA DE NOTIFICACIONES ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    alert("Â¡Notificaciones activadas con Ã©xito!");
                    document.getElementById('notif-btn').innerText = "âœ…";
                }
            });
        }

        function checkNotificationsLoop() {
            setInterval(() => {
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                const today = now.toISOString().split('T')[0];

                goals.forEach((goal, index) => {
                    if (goal.date === today && goal.time === currentTime && !goal.notified && !goal.completed) {
                        sendNotification(goal.text);
                        goal.notified = true; // Marcar como notificado para no repetir
                        saveAndRefresh();
                    }
                });
            }, 60000); // Revisar cada minuto
        }

        function sendNotification(text) {
            if (Notification.permission === "granted") {
                new Notification("Recordatorio de Meta ðŸš€", {
                    body: `Â¡Es hora de: ${text}!`,
                    icon: "https://cdn-icons-png.flaticon.com/512/3112/3112946.png"
                });
            }
        }

        // --- LÃ“GICA DE DATOS ---
        function addGoal() {
            const text = document.getElementById('goalInput').value;
            const date = document.getElementById('goalDate').value;
            const time = document.getElementById('goalTime').value;
            const priority = document.getElementById('goalPriority').value;

            if (text && date) {
                goals.push({ text, date, time, priority, completed: false, notified: false });
                document.getElementById('goalInput').value = '';
                saveAndRefresh();
            }
        }

        function toggleGoal(index) {
            goals[index].completed = !goals[index].completed;
            saveAndRefresh();
        }

        function deleteGoal(index) {
            goals.splice(index, 1);
            saveAndRefresh();
        }

        function saveAndRefresh() {
            localStorage.setItem('alert_goals_v2', JSON.stringify(goals));
            calendar.removeAllEvents();
            calendar.addEventSource(getEvents());
            renderGoals();
        }

        function renderGoals() {
            const list = document.getElementById('goalList');
            const today = new Date().toISOString().split('T')[0];
            const todayGoals = goals.filter(g => g.date === today);
            list.innerHTML = '';
            
            todayGoals.forEach((goal) => {
                const idx = goals.indexOf(goal);
                const li = document.createElement('li');
                li.className = `p-4 rounded-2xl bg-white/5 border-l-4 ${goal.priority === 'high' ? 'border-rose-500' : 'border-indigo-500'} flex justify-between items-center ${goal.completed ? 'opacity-30' : ''}`;
                li.innerHTML = `
                    <div class="flex flex-col cursor-pointer" onclick="toggleGoal(${idx})">
                        <span class="font-bold">${goal.text}</span>
                        <span class="text-[10px] text-indigo-400">${goal.time || 'Sin hora'}</span>
                    </div>
                    <button onclick="deleteGoal(${idx})" class="text-white/10 hover:text-rose-500 transition-colors">âœ•</button>
                `;
                list.appendChild(li);
            });
        }
    </script>
</body>
</html>