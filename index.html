<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metas Pro: Calendario, Alertas y Temas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        :root { --main-color: #6366f1; } /* Color por defecto */
        .glass { background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .fc { color: white; background: rgba(0,0,0,0.2); border-radius: 1.5rem; padding: 10px; font-size: 0.85rem; border: none !important; }
        .fc-toolbar-title { font-size: 1rem !important; text-transform: capitalize; }
        .fc-button { background-color: var(--main-color) !important; border: none !important; opacity: 0.8; }
        .fc-button:hover { opacity: 1; }
        .theme-dot { width: 20px; height: 20px; border-radius: 50%; cursor: pointer; border: 2px solid white; transition: transform 0.2s; }
        .theme-dot:hover { transform: scale(1.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .dynamic-bg { transition: background 0.5s ease; }
        .btn-main { background-color: var(--main-color); transition: all 0.3s; }
    </style>
</head>
<body id="main-body" class="bg-[#05070a] dynamic-bg min-h-screen text-white p-4 font-sans">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-6">
            <div class="glass p-6 rounded-[2.5rem] shadow-2xl relative">
                <div class="flex gap-2 mb-6 justify-center">
                    <div onclick="changeTheme('#6366f1', '#05070a')" class="theme-dot bg-indigo-500"></div>
                    <div onclick="changeTheme('#ec4899', '#1a0b14')" class="theme-dot bg-pink-500"></div>
                    <div onclick="changeTheme('#10b981', '#061310')" class="theme-dot bg-emerald-500"></div>
                    <div onclick="changeTheme('#f59e0b', '#130f06')" class="theme-dot bg-amber-500"></div>
                    <div onclick="changeTheme('#a855f7', '#0f0816')" class="theme-dot bg-purple-500"></div>
                </div>

                <div class="text-center mb-6">
                    <h1 id="greeting" class="text-2xl font-black">Â¡Hola! ðŸš€</h1>
                    <button onclick="requestNotificationPermission()" class="text-[10px] mt-2 text-indigo-300 uppercase tracking-widest hover:underline">
                        ðŸ”” Activar Alertas Sonoras
                    </button>
                </div>

                <div class="space-y-4">
                    <input type="text" id="goalInput" placeholder="Nombre de la meta" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl focus:ring-2 focus:ring-white/20 outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="goalDate" class="bg-white/5 border border-white/10 p-3 rounded-2xl text-xs text-white">
                        <input type="time" id="goalTime" class="bg-white/5 border border-white/10 p-3 rounded-2xl text-xs text-white">
                    </div>
                    <select id="goalPriority" class="w-full bg-slate-900 border border-white/10 p-3 rounded-2xl text-sm">
                        <option value="low">Prioridad Baja</option>
                        <option value="medium" selected>Prioridad Media</option>
                        <option value="high">Prioridad Alta</option>
                    </select>
                    <button onclick="addGoal()" class="btn-main w-full py-4 rounded-2xl font-black shadow-xl uppercase text-xs tracking-widest hover:brightness-110 active:scale-95 transition-all">
                        Programar Meta
                    </button>
                </div>
            </div>

            <div class="glass p-6 rounded-[2.5rem] h-[300px] flex flex-col">
                <h2 class="text-xs font-bold mb-4 opacity-60 uppercase tracking-widest">Metas para Hoy</h2>
                <ul id="goalList" class="space-y-3 overflow-y-auto flex-1 custom-scrollbar pr-2 text-sm"></ul>
            </div>
        </div>

        <div class="lg:col-span-8">
            <div class="glass p-6 rounded-[2.5rem] h-full shadow-2xl">
                <div id="calendar"></div>
            </div>
        </div>
    </div>

    <script>
        let goals = JSON.parse(localStorage.getItem('ultimate_goals_v1')) || [];
        let theme = JSON.parse(localStorage.getItem('app_theme')) || { main: '#6366f1', bg: '#05070a' };
        let calendar;

        document.addEventListener('DOMContentLoaded', () => {
            const userName = localStorage.getItem('userName_v3') || 'Usuario';
            document.getElementById('greeting').innerText = `Â¡Hola, ${userName}! ðŸ‘‹`;
            document.getElementById('goalDate').valueAsDate = new Date();
            
            applyTheme(theme.main, theme.bg);
            initCalendar();
            renderGoals();
            startAlertLoop();
        });

        function changeTheme(main, bg) {
            theme = { main, bg };
            localStorage.setItem('app_theme', JSON.stringify(theme));
            applyTheme(main, bg);
        }

        function applyTheme(main, bg) {
            document.documentElement.style.setProperty('--main-color', main);
            document.getElementById('main-body').style.backgroundColor = bg;
            const btn = document.querySelector('.btn-main');
            if(btn) btn.style.backgroundColor = main;
            if(calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(getEvents());
            }
        }

        function initCalendar() {
            calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: { left: 'prev,next', center: 'title', right: 'dayGridMonth,listMonth' },
                events: getEvents(),
                eventClick: (info) => toggleGoal(info.event.id)
            });
            calendar.render();
        }

        function getEvents() {
            return goals.map((g, index) => ({
                id: index.toString(),
                title: g.text,
                start: g.date + (g.time ? 'T' + g.time : ''),
                color: g.completed ? '#4ade80' : (g.priority === 'high' ? '#f87171' : theme.main)
            }));
        }

        // --- LÃ“GICA DE ALERTAS ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(p => { if(p === 'granted') alert("Â¡Alertas activadas!"); });
        }

        function startAlertLoop() {
            setInterval(() => {
                const now = new Date();
                const nowStr = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
                const todayStr = now.toISOString().split('T')[0];

                goals.forEach((g, i) => {
                    if (g.date === todayStr && g.time === nowStr && !g.notified && !g.completed) {
                        triggerAlarm(g.text);
                        g.notified = true;
                        saveData();
                    }
                });
            }, 10000); // Revisar cada 10 segundos
        }

        function triggerAlarm(text) {
            // Sonido
            const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
            audio.play().catch(e => console.log("Audio bloqueado por el navegador hasta que interactÃºes"));

            // NotificaciÃ³n visual
            if (Notification.permission === "granted") {
                new Notification("Â¡Es momento! ðŸš€", { body: text, icon: "https://cdn-icons-png.flaticon.com/512/3112/3112946.png" });
            } else {
                alert("â° RECORDATORIO: " + text);
            }
        }

        // --- CORE ---
        function addGoal() {
            const text = document.getElementById('goalInput').value;
            const date = document.getElementById('goalDate').value;
            const time = document.getElementById('goalTime').value;
            const priority = document.getElementById('goalPriority').value;

            if (text && date) {
                goals.push({ text, date, time, priority, completed: false, notified: false });
                document.getElementById('goalInput').value = '';
                saveData();
                renderGoals();
                calendar.removeAllEvents();
                calendar.addEventSource(getEvents());
            }
        }

        function toggleGoal(i) {
            goals[i].completed = !goals[i].completed;
            saveData();
            renderGoals();
            calendar.removeAllEvents();
            calendar.addEventSource(getEvents());
        }

        function deleteGoal(i) {
            goals.splice(i, 1);
            saveData();
            renderGoals();
            calendar.removeAllEvents();
            calendar.addEventSource(getEvents());
        }

        function saveData() { localStorage.setItem('ultimate_goals_v1', JSON.stringify(goals)); }

        function renderGoals() {
            const list = document.getElementById('goalList');
            const today = new Date().toISOString().split('T')[0];
            const todayGoals = goals.filter(g => g.date === today);
            list.innerHTML = '';
            todayGoals.forEach((g) => {
                const idx = goals.indexOf(g);
                const li = document.createElement('li');
                li.className = `p-4 rounded-2xl bg-white/5 border-l-4 flex justify-between items-center ${g.completed ? 'opacity-30' : ''}`;
                li.style.borderLeftColor = g.priority === 'high' ? '#f87171' : theme.main;
                li.innerHTML = `
                    <div class="flex flex-col cursor-pointer" onclick="toggleGoal(${idx})">
                        <span class="font-bold text-xs">${g.text}</span>
                        <span class="text-[9px] opacity-60">${g.time || '--:--'}</span>
                    </div>
                    <button onclick="deleteGoal(${idx})" class="text-white/20 hover:text-white">âœ•</button>
                `;
                list.appendChild(li);
            });
        }
    </script>
</body>
</html>